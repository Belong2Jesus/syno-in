<!DOCTYPE html>
<html>
  <head>
<script type="text/javascript">
  //function (){
    var base = document.createElement("BASE");
    base.setAttribute("href", location.protocol + "//" + location.host.split(/:/, 1)[0] + ":8081");
    document.head.appendChild(base);
    var apikey = "joljgcjedaaehhljacnpeadljljocmol";
    var link = document.createElement("LINK");
    link.setAttribute("rel", "chrome-webstore-item");
    link.setAttribute("href", "https://chrome.google.com/webstore/detail/" + apikey);
    document.head.appendChild(link);
  //}.();
</script>
    <title>Syno</title>
    <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.min.css">
    <script src="semantic/dist/semantic.min.js"></script>
    <script src="latest-v2.js"></script>
    <script src="socket.io.js"></script>
    <style>
      html { height: 100%; background: url("g.jpg"); background-size: cover }
      body { height: 100%; margin: 0; }
      #remotes { border: 1px inset black; height: 80% }
        .videoContainer { position: relative; display: inline-block; color: green; font-size: 8pt; overflow: scroll }
          .remoteVideo { position: absolute; top: 0; left: 0; height: 100%; width: 100% }
          .visionReport { position: absolute; top: 0; left: 0 height: 100%}
          .volume { position: absolute; bottom: 5px; left: 20%; height: 5px; width: 50%}
      #control { position: absolute; top: 0; right: 0 }
      #localBase { position: relative; height: 20%; }
        #chat { text-align: left; position: absolute; top 0; left: 0; width: 30% }
          #chatInput { width: 100% }
          #chatlog { word-wrap: break-word; overflow: hidden; width: 100%; color: white}
            #chatText { border-top: 1px solid blue }
        #LocalVideoConteiner { position: absolute; left: 40%; height: 100% ; }
          .x { display:none; position:absolute; left:0; top:0; height: 30px }
          #localVideo { float: left; height: 100% }
          #localControl { float: left; background-color: white }
            #lcMic {position: relative}
            #lcVideo {position: relative}
            #lcScreen {position: relative}
              .on { border : 1px solid aqua }
              .error { border : 1px solid red }
            #lcFile {position: relative; }
              #uploadLabel {color: white; background-color: red; padding: 6px; border-radius: 12px;}
        #editor {position: absolute; right: 0; background-color: white; width: 30%; height: 100%; color: black}
        #footer { float: right }
    </style>
  </head>
  <body>
    <div id="remotes"></div>
    <div id="control">
      <img src="r.png" height=50px onclick="location.reload()"><br>
      <img src="e.png" width=50 height=50 onclick="location.href=
        'mailto:?subject=Chatting%20via%20syno.in.%0D%0A&body=Hi%21%0D%0A%0D%0AClick%20below%3A%0D%0A'
        + location.href ">
    </div>
    <div id=localBase>
      <div id=chat>
        <input id="chatInput" type=text onChange="sendChat(this)" x-webkit-speech>
        <div id="chatLog"></div>
        <canvas id="snap" width="120" height="90" style="display:none"></canvas>
      </div>
      <div id="LocalVideoConteiner">
        <video id="localVideo"></video>
        <meter id="localVolume" class="volume" min="-45" max="-20" high="-25" low="-40"></meter>
        <div id="localControl">
          <div id=lcMic>
            <img src="m.png" height=30px>
            <img id="xMic" src="x.png" class="x" style="display:none">
          </div>
          <div id="lcVideo">
            <img src="c.png" height=30px>
            <img id="xVideo" src="x.png" class="x" style="display:none">
          </div>
          <div id="lcScreen">
            <img src="d.png" height=30px>
          </div>
          <div id="lcFile">
            <img src="f.png" height=30px style="-webkit-filter: grayscale(80%);" 
              onclick="document.getElementById('uploadInput').click()">
            <input type=file id="uploadInput" style="display:none">
          </div>
        </div>
      </div>
      <div id=editor contentEditable=true >
      </div>
    </div>
    <div id=footer>
      <img src=ss.png width=200px>
    </div>
    <script>
    // Local Control
      var lcMic = document.getElementById("lcMic");
      lcMic.addEventListener("mouseover", function(){bg(this, 'gray');}, false);
      lcMic.addEventListener("mouseout", function(){bg(this, 'transparent');}, false);
      lcMic.addEventListener("mousedown", function(){bg(this,'pink');}, false);
      lcMic.addEventListener("mouseup", function(){bg(this, 'gray');}, false);
      lcMic.addEventListener("click", mute, false);
      var lcVideo = document.getElementById("lcVideo");
      lcVideo.addEventListener("mouseover", function(){bg(this, 'gray');}, false);
      lcVideo.addEventListener("mouseout", function(){bg(this, 'transparent');}, false);
      lcVideo.addEventListener("mousedown", function(){bg(this,'pink');}, false);
      lcVideo.addEventListener("mouseup", function(){bg(this, 'gray');}, false);
      lcVideo.addEventListener("click", pause, false);
      var lcScreen = document.getElementById("lcScreen");
      lcScreen.addEventListener("mouseover", function(){bg(this, 'gray');}, false);
      lcScreen.addEventListener("mouseout", function(){bg(this, 'transparent');}, false);
      lcScreen.addEventListener("mousedown", function(){bg(this,'pink');}, false);
      lcScreen.addEventListener("mouseup", function(){bg(this, 'gray');}, false);
      lcScreen.addEventListener("click", shareScreen, false);
      var muted = paused = false;
      function bg(el, cl){el.style.backgroundColor=cl;}
      function mute(){
        if (muted) {
          webrtc.unmute();
          document.getElementById("xMic").style.display="none";
        } else {
          webrtc.mute();
          document.getElementById("xMic").style.display="inline";
        }
        muted = !(muted);
      }
      function pause(){
        if(paused) {
          webrtc.resumeVideo();
          document.getElementById("xVideo").style.display="none";
        } else {
          webrtc.pauseVideo();
          document.getElementById("xVideo").style.display="inline";
        }
        paused = !(paused);
      }
      function shareScreen(){
        if (sessionStorage.getScreenMediaJSExtensionId == apikey){
          if (webrtc.getLocalScreen()) {
            lcScreen.classList.remove("on");
            webrtc.stopScreenShare();
          } else {
            webrtc.shareScreen(function (err) {
              if (err) {
                // lcScreen.classList.add("err");
                console.log(err); // ToDo: error
              } else {
                lcScreen.classList.add("on");
                alignVideo();
              }
            });
          }
        } else {
          chrome.webstore.install(
          "https://chrome.google.com/webstore/detail/" + apikey,
          function (){ location.reload(true) }, function (){ /* todo: */ });
        }
      }




    // connect to lobby
      var webrtc = new SimpleWebRTC({
        url: location.origin,
        localVideoEl: 'localVideo',
        remoteVideosEl: '',
        autoRequestMedia: true,
        detectSpeakingEvents: true,
//        peerConnectionConfig: {iceServers:[
//          {url: "stun:syno.in:53"},
//          {url: "turn:stun.syno.in:53?transport=tcp", username: "synou", credential: "syno"}]},
//          {url: "turn:syno.in:53", username: "synou", credential: "syno"}]},
        media: { video: { mandatory: { maxWidth: 320, maxHeight: 240, maxFrameRate: 8 } }, 
                 audio: true }
      });
    // join session
      webrtc.on('connectionReady', function () {
      });
      webrtc.on('readyToCall', function () {
        webrtc.joinRoom(location.pathname.substr(1));
      });
      webrtc.on('localScreenAdded', function (el){
        alignVideo();
      });
    // video resize
      webrtc.on('videoAdded', function (video, peer) {
        video.className = "remoteVideo";
        video.onclick = analyzeImage;
        var container = document.createElement('div');
        container.className = 'videoContainer';
        container.id = 'container_' + webrtc.getDomId(peer);
        container.appendChild(video);
        // show the remote volume
        var vol = document.createElement('meter');
        vol.id = 'volume_' + peer.id;
        vol.className = 'volume';
        vol.min = -45;
        vol.max = -20;
        vol.low = -40;
        vol.high = -25;
        container.appendChild(vol);
        document.getElementById('remotes').appendChild(container);
        // receive file
        peer.on('fileTransfer', function (metadata, receiver) {
          console.log('incoming filetransfer', metadata);

          // hook up receive progress
          receiver.on('progress', function (bytesReceived) {
          });
          // get notified when file is done
          receiver.on('receivedFile', function (file, metadata) {
            console.log('received file', metadata.name, metadata.size);
            var href = document.createElement('a');
            href.href = URL.createObjectURL(file);
            href.download = metadata.name;
            href.appendChild(document.createTextNode(metadata.name));
            var context = document.getElementById("snap").getContext("2d");
            context.beginPath();
            context.rect(15, 0, 90, 90);
            context.clip();
            context.drawImage(video, 0, 0, 120, 90);
            var snap = document.getElementById("snap").toDataURL();
            var html = '<div class=chatText><img style="float:left" width="60" src="' + snap + '">' +
                '<a href="' + URL.createObjectURL(file) + '" download="' + metadata.name + '">' +
                metadata.name + '</a><p style="clear:both"></p></div>';
            apendChat(html);
            // close the channel
            receiver.channel.close();
          });
        });
        alignVideo();
      });



      // send a file
      document.getElementById("uploadInput").addEventListener('change', function() {
        var _self = this;
        _self.disabled = true;
// todo: disabled=false when all is finished
        var file = _self.files[0];
        webrtc.getPeers().forEach( function (peer) {
          var sender = peer.sendFile(file);
          sender.on('progress', function (bytesSent) {
            console.log(bytesSent);
          });
          sender.on('sentFile', function () {
//            fileinput.removeAttribute('disabled'); // todo
          });
          sender.on('complete', function () {
          });
        });
      }, false);



      webrtc.on('videoRemoved', function (video, peer) {
        var elid = (peer) ? 'container_' + webrtc.getDomId(peer) : 'localScreenContainer';
        if ( document.getElementById(elid) ) {
          document.getElementById('remotes').removeChild(document.getElementById(elid));
        }
        alignVideo();
      });
      function alignVideo () {
        var rm = document.getElementById("remotes");
        var vc = remotes.getElementsByClassName("videoContainer");
        if (vc.length > 0){
          var h = [100, 100,  49,  49,  49,  49,  33 ];
          var w = [100,  49,  33,  33,  33,  33,  33 ];
          if ( rm.offsetHeight * 680 / 320 < rm.offsetWidth ) {
            h = [100,  50,  33,  33,  33,  33,  33 ];
            w = [100, 100, 100,  50,  50,  50,  33 ];
          }
          for (var i = 0, ii = vc.length; i < ii; i++) {
            vc[i].style.height = ( (ii > 6) ? h[6] : h[ii-1] ) + "%";
            vc[i].style.width  = ( (ii > 6) ? w[6] : w[ii-1] ) + "%";
          }
        }
      }
    // Analyze Image
      function analyzeImage(){
        var _self = this;
        var snap = document.getElementById("snap");
        var context = snap.getContext("2d");
        context.beginPath();
        // context.rect(15, 0, 90, 90);
        context.clip();
        context.drawImage(_self, 0, 0, _self.width, _self.height);
          var r = new XMLHttpRequest();
          r.open("POST", "https://vision.googleapis.com/v1/images:annotate?key=" +
                         "AIzaSyCepv-_QAsYMnxa93R9Iaeu7iXHC0_LvEk", true);
          r.setRequestHeader("Content-Type","application/json");
          r.onreadystatechange = function () {
            // if (r.readyState != 4 || r.status != 200) return;
            var res = document.createElement("div");
            res.innerHTML = '<pre>' + r.responseText + '</pre>';
            res.style.position = "absolute";
            res.style.top = _self.getBoundingClientRect().top;
            res.style.left = document.getElementById(_self.id).getBoundingClientRect().left;
            res.style.height = _self.style.height;
            res.style.width = _self.style.width;
            _self.parentNode.appendChild(res);
          };
          // r.responseType = "json";
          var data = {"requests": [ { 
            "image": { "content": snap.toDataURL().replace('data:image/png;base64,','') }, 
            "features": [ 
                { "type": "FACE_DETECTION", "maxResults": 5},
                { "type": "LANDMARK_DETECTION", "maxResults": 5},
                { "type": "LOGO_DETECTION", "maxResults": 5},
                { "type": "LABEL_DETECTION", "maxResults": 5},
                { "type": "TEXT_DETECTION", "maxResults": 5},
                { "type": "SAFE_SEARCH_DETECTION", "maxResults": 5},
                { "type": "IMAGE_PROPERTIES", "maxResults": 5}
          ]}]};
          r.send(JSON.stringify(data));
      }
    // chat
      webrtc.on('joinedRoom', function () {
        webrtc.sendDirectlyToAll("all", "chat", ""); // chat no omajinai
        webrtc.sendDirectlyToAll("all", "note", ""); // chat no omajinai
      });
      function sendChat(_text) {
        var context = document.getElementById("snap").getContext("2d");
        context.beginPath();
        context.rect(15, 0, 90, 90);
        context.clip();
        context.drawImage(document.getElementById("localVideo"),0, 0, 120, 90);
        var snap = document.getElementById("snap").toDataURL();
        var html = '<div class=chatText><img style="float:left" width="60" src="' + snap + '">' + 
            _text.value.replace(/((http:|https:)\/\/[\x21-\x26\x28-\x7e]+)/gi,
              "<a href='$1' target=_blank>$1</a>") + '<p style="clear:both"></p></div>';
        webrtc.sendDirectlyToAll("all", "chat", html);
        apendChat(html);
        _text.value = '';
      }
      function apendChat(_text){
        var newElement = document.createElement('div');
        newElement.innerHTML = _text;
        var parentElement = document.getElementById("chatLog");
        parentElement.insertBefore(newElement, parentElement.firstChild);
      }

    // show volume
            function showVolume(el, volume) {
              if(el){
                if (volume < -45) volume = -45; // -45 to -20 is
                if (volume > -20) volume = -20; // a good range
                el.value = volume;
              }
            }

            // local volume has changed
            webrtc.on('volumeChange', function (volume, treshold) {
                showVolume(document.getElementById('localVolume'), volume);
            });
            // remote volume has changed
            webrtc.on('remoteVolumeChange', function (peer, volume) {
                showVolume(document.getElementById('volume_' + peer.id), volume);
            });

    // receive note change event
      ed = document.getElementById('editor');
      ed.addEventListener("input", function() {
        var sel = document.getSelection();
        webrtc.sendDirectlyToAll("all", "note", {text: ed.innerHTML, pos: sel.focusOffset});
      }, false);
      function updateNote(mod){
        var sel = document.getSelection();
        if (sel.rangeCount == 1){
          var range = sel.getRangeAt(0);
          var pos = range.startOffset;
          ed.innerHTML = mod.text;
console.log(mod.pos, pos);
          if (mod.pos < pos){
            range.setStart(ed, pos);
            range.setEnd(sel.baseNode, pos);
            sel.removeAllRanges();
            sel.addRange(range);
          } else {
            range.setStart(ed, pos);
            range.setEnd(sel.baseNode, pos);
            sel.removeAllRanges();
            sel.addRange(range);
          }
        } else {
          ed.innerHTML = mod.text;
        }
      }
      webrtc.on('channelMessage', function (peer, label, data, ch, ev) {
        if (data.type == 'chat') {
          apendChat(data.payload);
        } else if (data.type == 'volume') {
          showVolume(document.getElementById('volume_' + peer.id), data.volume);
        } else if (data.type == 'note') {
          updateNote(data.payload);
        }
      });
    </script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-7928254-5', 'syno.jp');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');
</script>

  </body>
</html>






